var De=Object.create,L=Object.defineProperty,Ie=Object.getPrototypeOf,qe=Object.prototype.hasOwnProperty,Ge=Object.getOwnPropertyNames,Je=Object.getOwnPropertyDescriptor;var ne=e=>L(e,"__esModule",{value:!0});var N=(e,t)=>()=>(t||(t={exports:{}},e(t.exports,t)),t.exports),We=(e,t)=>{for(var r in t)L(e,r,{get:t[r],enumerable:!0})},Ue=(e,t,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Ge(t))!qe.call(e,n)&&n!=="default"&&L(e,n,{get:()=>t[n],enumerable:!(r=Je(t,n))||r.enumerable});return e},w=e=>e&&e.__esModule?e:Ue(ne(L(e!=null?De(Ie(e)):{},"default",{value:e,enumerable:!0})),e);var se=N((wt,re)=>{re.exports=function(e,t){for(var r=[],n=0;n<e.length;n++){var s=t(e[n],n);Ze(s)?r.push.apply(r,s):r.push(s)}return r};var Ze=Array.isArray||function(e){return Object.prototype.toString.call(e)==="[object Array]"}});var ue=N((Et,ie)=>{"use strict";ie.exports=ae;function ae(e,t,r){e instanceof RegExp&&(e=oe(e,r)),t instanceof RegExp&&(t=oe(t,r));var n=ce(e,t,r);return n&&{start:n[0],end:n[1],pre:r.slice(0,n[0]),body:r.slice(n[0]+e.length,n[1]),post:r.slice(n[1]+t.length)}}function oe(e,t){var r=t.match(e);return r?r[0]:null}ae.range=ce;function ce(e,t,r){var n,s,i,o,u,a=r.indexOf(e),c=r.indexOf(t,a+1),l=a;if(a>=0&&c>0){for(n=[],i=r.length;l>=0&&!u;)l==a?(n.push(l),a=r.indexOf(e,l+1)):n.length==1?u=[n.pop(),c]:(s=n.pop(),s<i&&(i=s,o=c),c=r.indexOf(t,l+1)),l=a<c&&a>=0?a:c;n.length&&(u=[i,o])}return u}});var ve=N((St,le)=>{var ze=se(),fe=ue();le.exports=He;var he="\0SLASH"+Math.random()+"\0",pe="\0OPEN"+Math.random()+"\0",Z="\0CLOSE"+Math.random()+"\0",ge="\0COMMA"+Math.random()+"\0",de="\0PERIOD"+Math.random()+"\0";function z(e){return parseInt(e,10)==e?parseInt(e,10):e.charCodeAt(0)}function Qe(e){return e.split("\\\\").join(he).split("\\{").join(pe).split("\\}").join(Z).split("\\,").join(ge).split("\\.").join(de)}function Ve(e){return e.split(he).join("\\").split(pe).join("{").split(Z).join("}").split(ge).join(",").split(de).join(".")}function me(e){if(!e)return[""];var t=[],r=fe("{","}",e);if(!r)return e.split(",");var n=r.pre,s=r.body,i=r.post,o=n.split(",");o[o.length-1]+="{"+s+"}";var u=me(i);return i.length&&(o[o.length-1]+=u.shift(),o.push.apply(o,u)),t.push.apply(t,o),t}function He(e){return e?(e.substr(0,2)==="{}"&&(e="\\{\\}"+e.substr(2)),k(Qe(e),!0).map(Ve)):[]}function Ke(e){return"{"+e+"}"}function Xe(e){return/^-?0\d/.test(e)}function Ye(e,t){return e<=t}function et(e,t){return e>=t}function k(e,t){var r=[],n=fe("{","}",e);if(!n||/\$$/.test(n.pre))return[e];var s=/^-?\d+\.\.-?\d+(?:\.\.-?\d+)?$/.test(n.body),i=/^[a-zA-Z]\.\.[a-zA-Z](?:\.\.-?\d+)?$/.test(n.body),o=s||i,u=n.body.indexOf(",")>=0;if(!o&&!u)return n.post.match(/,.*\}/)?(e=n.pre+"{"+n.body+Z+n.post,k(e)):[e];var a;if(o)a=n.body.split(/\.\./);else if(a=me(n.body),a.length===1&&(a=k(a[0],!1).map(Ke),a.length===1)){var l=n.post.length?k(n.post,!1):[""];return l.map(function(G){return n.pre+a[0]+G})}var c=n.pre,l=n.post.length?k(n.post,!1):[""],h;if(o){var S=z(a[0]),x=z(a[1]),y=Math.max(a[0].length,a[1].length),m=a.length==3?Math.abs(z(a[2])):1,R=Ye,p=x<S;p&&(m*=-1,R=et);var d=a.some(Xe);h=[];for(var C=S;R(C,x);C+=m){var v;if(i)v=String.fromCharCode(C),v==="\\"&&(v="");else if(v=String(C),d){var B=y-v.length;if(B>0){var T=new Array(B+1).join("0");C<0?v="-"+T+v.slice(1):v=T+v}}h.push(v)}}else h=ze(a,function(F){return k(F,!1)});for(var A=0;A<h.length;A++)for(var $=0;$<l.length;$++){var _=c+h[A]+l[$];(!t||o||_)&&r.push(_)}return r}});var Ce=N((Ct,xe)=>{xe.exports=b;b.Minimatch=g;var M={sep:"/"};try{M=require("path")}catch(e){}var H=b.GLOBSTAR=g.GLOBSTAR={},tt=ve(),ye={"!":{open:"(?:(?!(?:",close:"))[^/]*?)"},"?":{open:"(?:",close:")?"},"+":{open:"(?:",close:")+"},"*":{open:"(?:",close:")*"},"@":{open:"(?:",close:")"}},Q="[^/]",V=Q+"*?",nt="(?:(?!(?:\\/|^)(?:\\.{1,2})($|\\/)).)*?",rt="(?:(?!(?:\\/|^)\\.).)*?",be=st("().*{}+?[]^$\\!");function st(e){return e.split("").reduce(function(t,r){return t[r]=!0,t},{})}var we=/\/+/;b.filter=it;function it(e,t){return t=t||{},function(r,n,s){return b(r,e,t)}}function Ee(e,t){e=e||{},t=t||{};var r={};return Object.keys(t).forEach(function(n){r[n]=t[n]}),Object.keys(e).forEach(function(n){r[n]=e[n]}),r}b.defaults=function(e){if(!e||!Object.keys(e).length)return b;var t=b,r=function(s,i,o){return t.minimatch(s,i,Ee(e,o))};return r.Minimatch=function(s,i){return new t.Minimatch(s,Ee(e,i))},r};g.defaults=function(e){return!e||!Object.keys(e).length?g:b.defaults(e).Minimatch};function b(e,t,r){if(typeof t!="string")throw new TypeError("glob pattern string required");return r||(r={}),!r.nocomment&&t.charAt(0)==="#"?!1:t.trim()===""?e==="":new g(t,r).match(e)}function g(e,t){if(!(this instanceof g))return new g(e,t);if(typeof e!="string")throw new TypeError("glob pattern string required");t||(t={}),e=e.trim(),M.sep!=="/"&&(e=e.split(M.sep).join("/")),this.options=t,this.set=[],this.pattern=e,this.regexp=null,this.negate=!1,this.comment=!1,this.empty=!1,this.make()}g.prototype.debug=function(){};g.prototype.make=at;function at(){if(!this._made){var e=this.pattern,t=this.options;if(!t.nocomment&&e.charAt(0)==="#"){this.comment=!0;return}if(!e){this.empty=!0;return}this.parseNegate();var r=this.globSet=this.braceExpand();t.debug&&(this.debug=console.error),this.debug(this.pattern,r),r=this.globParts=r.map(function(n){return n.split(we)}),this.debug(this.pattern,r),r=r.map(function(n,s,i){return n.map(this.parse,this)},this),this.debug(this.pattern,r),r=r.filter(function(n){return n.indexOf(!1)===-1}),this.debug(this.pattern,r),this.set=r}}g.prototype.parseNegate=ot;function ot(){var e=this.pattern,t=!1,r=this.options,n=0;if(!r.nonegate){for(var s=0,i=e.length;s<i&&e.charAt(s)==="!";s++)t=!t,n++;n&&(this.pattern=e.substr(n)),this.negate=t}}b.braceExpand=function(e,t){return Se(e,t)};g.prototype.braceExpand=Se;function Se(e,t){if(t||(this instanceof g?t=this.options:t={}),e=typeof e=="undefined"?this.pattern:e,typeof e=="undefined")throw new TypeError("undefined pattern");return t.nobrace||!e.match(/\{.*\}/)?[e]:tt(e)}g.prototype.parse=ct;var D={};function ct(e,t){if(e.length>1024*64)throw new TypeError("pattern is too long");var r=this.options;if(!r.noglobstar&&e==="**")return H;if(e==="")return"";var n="",s=!!r.nocase,i=!1,o=[],u=[],a,c=!1,l=-1,h=-1,S=e.charAt(0)==="."?"":r.dot?"(?!(?:^|\\/)\\.{1,2}(?:$|\\/))":"(?!\\.)",x=this;function y(){if(a){switch(a){case"*":n+=V,s=!0;break;case"?":n+=Q,s=!0;break;default:n+="\\"+a;break}x.debug("clearStateChar %j %j",a,n),a=!1}}for(var m=0,R=e.length,p;m<R&&(p=e.charAt(m));m++){if(this.debug("%s	%s %s %j",e,m,n,p),i&&be[p]){n+="\\"+p,i=!1;continue}switch(p){case"/":return!1;case"\\":y(),i=!0;continue;case"?":case"*":case"+":case"@":case"!":if(this.debug("%s	%s %s %j <-- stateChar",e,m,n,p),c){this.debug("  in class"),p==="!"&&m===h+1&&(p="^"),n+=p;continue}x.debug("call clearStateChar %j",a),y(),a=p,r.noext&&y();continue;case"(":if(c){n+="(";continue}if(!a){n+="\\(";continue}o.push({type:a,start:m-1,reStart:n.length,open:ye[a].open,close:ye[a].close}),n+=a==="!"?"(?:(?!(?:":"(?:",this.debug("plType %j %j",a,n),a=!1;continue;case")":if(c||!o.length){n+="\\)";continue}y(),s=!0;var d=o.pop();n+=d.close,d.type==="!"&&u.push(d),d.reEnd=n.length;continue;case"|":if(c||!o.length||i){n+="\\|",i=!1;continue}y(),n+="|";continue;case"[":if(y(),c){n+="\\"+p;continue}c=!0,h=m,l=n.length,n+=p;continue;case"]":if(m===h+1||!c){n+="\\"+p,i=!1;continue}if(c){var C=e.substring(h+1,m);try{RegExp("["+C+"]")}catch(ee){var v=this.parse(C,D);n=n.substr(0,l)+"\\["+v[0]+"\\]",s=s||v[1],c=!1;continue}}s=!0,c=!1,n+=p;continue;default:y(),i?i=!1:be[p]&&!(p==="^"&&c)&&(n+="\\"),n+=p}}for(c&&(C=e.substr(h+1),v=this.parse(C,D),n=n.substr(0,l)+"\\["+v[0],s=s||v[1]),d=o.pop();d;d=o.pop()){var B=n.slice(d.reStart+d.open.length);this.debug("setting tail",n,d),B=B.replace(/((?:\\{2}){0,64})(\\?)\|/g,function(ee,te,U){return U||(U="\\"),te+te+U+"|"}),this.debug(`tail=%j
   %s`,B,B,d,n);var T=d.type==="*"?V:d.type==="?"?Q:"\\"+d.type;s=!0,n=n.slice(0,d.reStart)+T+"\\("+B}y(),i&&(n+="\\\\");var A=!1;switch(n.charAt(0)){case".":case"[":case"(":A=!0}for(var $=u.length-1;$>-1;$--){var _=u[$],F=n.slice(0,_.reStart),G=n.slice(_.reStart,_.reEnd-8),X=n.slice(_.reEnd-8,_.reEnd),j=n.slice(_.reEnd);X+=j;var Fe=F.split("(").length-1,J=j;for(m=0;m<Fe;m++)J=J.replace(/\)[+*?]?/,"");j=J;var Y="";j===""&&t!==D&&(Y="$");var Le=F+G+j+Y+X;n=Le}if(n!==""&&s&&(n="(?=.)"+n),A&&(n=S+n),t===D)return[n,s];if(!s)return ut(e);var Ne=r.nocase?"i":"";try{var W=new RegExp("^"+n+"$",Ne)}catch(ee){return new RegExp("$.")}return W._glob=e,W._src=n,W}b.makeRe=function(e,t){return new g(e,t||{}).makeRe()};g.prototype.makeRe=lt;function lt(){if(this.regexp||this.regexp===!1)return this.regexp;var e=this.set;if(!e.length)return this.regexp=!1,this.regexp;var t=this.options,r=t.noglobstar?V:t.dot?nt:rt,n=t.nocase?"i":"",s=e.map(function(i){return i.map(function(o){return o===H?r:typeof o=="string"?ft(o):o._src}).join("\\/")}).join("|");s="^(?:"+s+")$",this.negate&&(s="^(?!"+s+").*$");try{this.regexp=new RegExp(s,n)}catch(i){this.regexp=!1}return this.regexp}b.match=function(e,t,r){r=r||{};var n=new g(t,r);return e=e.filter(function(s){return n.match(s)}),n.options.nonull&&!e.length&&e.push(t),e};g.prototype.match=ht;function ht(e,t){if(this.debug("match",e,this.pattern),this.comment)return!1;if(this.empty)return e==="";if(e==="/"&&t)return!0;var r=this.options;M.sep!=="/"&&(e=e.split(M.sep).join("/")),e=e.split(we),this.debug(this.pattern,"split",e);var n=this.set;this.debug(this.pattern,"set",n);var s,i;for(i=e.length-1;i>=0&&(s=e[i],!s);i--);for(i=0;i<n.length;i++){var o=n[i],u=e;r.matchBase&&o.length===1&&(u=[s]);var a=this.matchOne(u,o,t);if(a)return r.flipNegate?!0:!this.negate}return r.flipNegate?!1:this.negate}g.prototype.matchOne=function(e,t,r){var n=this.options;this.debug("matchOne",{this:this,file:e,pattern:t}),this.debug("matchOne",e.length,t.length);for(var s=0,i=0,o=e.length,u=t.length;s<o&&i<u;s++,i++){this.debug("matchOne loop");var a=t[i],c=e[s];if(this.debug(t,a,c),a===!1)return!1;if(a===H){this.debug("GLOBSTAR",[t,a,c]);var l=s,h=i+1;if(h===u){for(this.debug("** at the end");s<o;s++)if(e[s]==="."||e[s]===".."||!n.dot&&e[s].charAt(0)===".")return!1;return!0}for(;l<o;){var S=e[l];if(this.debug(`
globstar while`,e,l,t,h,S),this.matchOne(e.slice(l),t.slice(h),r))return this.debug("globstar found match!",l,o,S),!0;if(S==="."||S===".."||!n.dot&&S.charAt(0)==="."){this.debug("dot detected!",e,l,t,h);break}this.debug("globstar swallow a segment, and continue"),l++}return!!(r&&(this.debug(`
>>> no match, partial?`,e,l,t,h),l===o))}var x;if(typeof a=="string"?(n.nocase?x=c.toLowerCase()===a.toLowerCase():x=c===a,this.debug("string match",a,c,x)):(x=c.match(a),this.debug("pattern match",a,c,x)),!x)return!1}if(s===o&&i===u)return!0;if(s===o)return r;if(i===u){var y=s===o-1&&e[s]==="";return y}throw new Error("wtf?")};function ut(e){return e.replace(/\\(.)/g,"$1")}function ft(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}});ne(exports);We(exports,{activate:()=>yt});var f=w(require("coc.nvim")),Te=w(Ce()),E=w(require("path"));var pt=w(require("path")),_e=w(require("child_process"));async function O(e,t,r){return new Promise(n=>{let s=_e.spawn(e,t,{stdio:["pipe","pipe","pipe"]});r&&(s.stdin.write(r),s.stdin.end());let i=0,o=[],u=[];s.stdout.on("data",a=>{o.push(a)}),s.stderr.on("data",a=>{u.push(a)}),s.on("close",a=>{a&&(i=a),n({exitCode:i,data:o.length==0?void 0:Buffer.concat(o),error:u.length==0?void 0:Buffer.concat(u)})})})}var Oe=w(require("fs"));async function Be(e){return new Promise(t=>{Oe.default.stat(e,(r,n)=>{r==null?t({stats:n,error:void 0}):t({stats:void 0,error:r})})})}async function $e(e,t){let r,n;if(t=="rg")n=t,r=["--color","never","--files",e];else if(t=="find"||t==null)n="find",r=[e,"-type","f"];else return null;let s=await O(n,r);return s.exitCode!=0?(s.error,null):s.data?s.data.toString().trimEnd().split(`
`):null}var Pe=w(require("coc.nvim"));var Ae=w(require("coc.nvim"));function I(e,t){return Ae.workspace.getConfiguration("coc-ext").get(e,t)}var gt=w(require("path"));function ke(e){return typeof e=="string"?e:e instanceof String?e.toString():JSON.stringify(e,null,2)}var K=w(require("path")),je=class{constructor(){this.channel=Pe.window.createOutputChannel("coc-ext"),this.detail=I("log.detail",!1)===!0,this.level=I("log.level",1)}dispose(){return this.channel.dispose()}logLevel(t,r){var o;let n=new Date,s=ke(r);if(this.detail){let u=(o=new Error().stack)==null?void 0:o.split(`
`);if(u&&u.length>=4){let c=/at ((.*) \()?([^:]+):(\d+):(\d+)\)?/g.exec(u[3]);if(c){let l=K.default.basename(c[3]),h=c[4];this.channel.appendLine(`${n.toISOString()} ${t} [${l}:${h}] ${s}`);return}}}let i=K.default.basename(__filename);this.channel.appendLine(`${t} [${i}] ${s}`)}debug(t){this.level>0||this.logLevel("D",t)}info(t){this.level>1||this.logLevel("I",t)}warn(t){this.level>2||this.logLevel("W",t)}error(t){this.logLevel("E",t)}},P=new je;var dt=w(require("util"));function mt(e){if(e.length==0)return"0";let t=0;return e[e.length-1]=="="&&(t=e.length>=2&&e[e.length-2]=="="?2:1),`${e.substr(0,e.length-t).replace(/\+/gi,"-").replace(/\//gi,"_")}${t}`}function vt(e){let t=e.charCodeAt(e.length-1)-"0".charCodeAt(0);return`${e.substr(0,e.length-1).replace(/-/gi,"+").replace(/_/gi,"/")}${"=".repeat(t)}`}async function Me(e,t){let r=t.openssl?t.openssl:"openssl",n=["enc","-e","-aes256","-pbkdf2","-pass",`pass:${t.password}`,t.salt?"-salt":"-nosalt","-base64","-A"],s=await O(r,n,e);return s.exitCode==0&&s.data?`${t.prefix?t.prefix:""}${mt(s.data.toString())}${t.suffix?t.suffix:""}`:null}async function Re(e,t){let r=e;if(t.prefix){if(r.length<=t.prefix.length)return null;r=r.substr(t.prefix.length)}if(t.suffix){if(r.length<=t.suffix.length)return null;r=r.substr(1,r.length-t.suffix.length)}r=vt(r);let n=t.openssl?t.openssl:"openssl",s=["des","-d","-aes256","-pbkdf2","-pass",`pass:${t.password}`,t.salt?"-salt":"-nosalt","-base64","-A"],i=await O(n,s,r);return i.exitCode==0&&i.data?i.data.toString():null}var xt="coc-ext-crypto.json",q=class{constructor(t,r){this.conf=t;this.cont=r;this.conf_path=t,this.setting=JSON.parse(r),this.aes256key={password:this.setting.password,openssl:this.setting.openssl,prefix:"enc_"},this.include_pattern=[],this.setting.includes&&this.setting.includes.forEach(n=>{this.include_pattern.push(this.newMinimatch(n))}),this.exclude_pattern=[this.newMinimatch(this.conf_path),this.newMinimatch(`**/${this.aes256key.prefix}*`)],this.setting.excludes&&this.setting.excludes.forEach(n=>{this.exclude_pattern.push(this.newMinimatch(n))})}static async createAsync(t){try{let r=await f.workspace.readFile(t);return new q(t,r)}catch(r){return f.window.showMessage(`parse config file ${t} fail`),null}}getEncryptCmd(t,r){let n=["enc","-e","-aes256","-pbkdf2","-pass",`pass:${this.setting.password}`,this.setting.salt?"-salt":"-nosalt","-out",t];return r&&r.length!=0&&n.push("-in",r),{exec:this.setting.openssl?this.setting.openssl:"openssl",args:n}}getDecryptCmd(t,r){let n=["des","-d","-aes256","-pbkdf2","-pass",`pass:${this.setting.password}`,this.setting.salt?"-salt":"-nosalt","-in",t];return r&&r.length!=0&&n.push("-out",r),{exec:this.setting.openssl?this.setting.openssl:"openssl",args:n}}shouldEncrypt(t){let r=E.default.resolve(t);for(let n of this.exclude_pattern)if(n.match(r))return!1;for(let n of this.include_pattern)if(n.match(r))return!0;return!1}newMinimatch(t){return new Te.default.Minimatch(E.default.resolve(t),{matchBase:!0})}async getEncFilename(t){let r=E.default.dirname(t),n=E.default.basename(t),s=await Me(n,this.aes256key);return s?E.default.join(r,s):null}async getDesFilename(t){let r=E.default.dirname(t),n=E.default.basename(t),s=await Re(n,this.aes256key);return s?E.default.join(r,s):null}async encryptToFile(t){let r=await this.getEncFilename(f.Uri.parse(t.uri).fsPath);if(r==null)return null;let n=this.getEncryptCmd(r);return O(n.exec,n.args,t.textDocument.getText())}async encryptAllFiles(){let t=[];if(this.setting.includes)for(let n of this.setting.includes)t.push(E.default.resolve(n));let r=await $e(f.workspace.root,"find");if(!r){f.window.showMessage("get file list fail");return}for(let n of r)if(this.shouldEncrypt(n)){let s=await this.getEncFilename(f.Uri.parse(n).fsPath);if(s==null)continue;let i=this.getEncryptCmd(s,n);(await O(i.exec,i.args)).exitCode!=0&&P.error(`encrypt ${n} fail`)}}async decryptFromFile(t){let r=await this.getEncFilename(f.Uri.parse(t.uri).fsPath);if(r==null)return!1;let n=this.getDecryptCmd(r),s=await O(n.exec,n.args);if(s.error!=null||s.data==null)return!1;let i=f.TextEdit.replace({start:{line:0,character:0},end:{line:t.lineCount,character:0}},s.data.toString());return await t.applyEdits([i]),!0}isAutoEncrypt(){return this.setting.autoEnc!=null&&this.setting.autoEnc}};async function yt(e){e.logger.info("coc-ext-crypto works"),P.info("coc-ext-crypto works");let t=E.default.join(f.workspace.root,xt),r=await Be(t);if(!(!r.error&&r.stats&&r.stats.isFile()))return;let n=await q.createAsync(t);!n||(e.subscriptions.push(f.commands.registerCommand("ext-decrypt",async()=>{let s=await f.workspace.document;await n.decryptFromFile(s)}),f.commands.registerCommand("ext-encrypt-all",async()=>{n.encryptAllFiles()})),n.isAutoEncrypt()&&e.subscriptions.push(f.events.on("BufWritePost",async()=>{P.debug("?");let s=await f.workspace.document;if(n.shouldEncrypt(f.Uri.parse(s.uri).fsPath)){let i=await n.encryptToFile(s);i||P.error("encrypt fail"),i&&i.error&&P.error(i.error)}})))}
